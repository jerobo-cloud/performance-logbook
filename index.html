<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Performance Logbook</title>

<style>
:root{
  --bg:#0b0f14;
  --card:#121824;
  --card2:#151d2a;
  --panel:#0f1622;
  --text:#e6eaf0;
  --muted:#9aa4b2;
  --muted2:#6f7a89;

  /* Your blue */
  --blue:#2F7CF6;

  /* Subtle improvement green */
  --green:#4CAF50;

  /* Borders + shadows */
  --stroke: rgba(255,255,255,.06);
  --stroke2: rgba(255,255,255,.09);
  --shadow: 0 10px 30px rgba(0,0,0,.35);
}

*{box-sizing:border-box}
html,body{height:100%}
body{
  margin:0;
  color:var(--text);
  font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,system-ui,sans-serif;
  background:
    radial-gradient(900px 520px at 40% -140px, rgba(47,124,246,.20), transparent 60%),
    radial-gradient(900px 520px at 70% -220px, rgba(47,124,246,.10), transparent 65%),
    radial-gradient(1200px 700px at 50% -260px, #121c2a, transparent 65%),
    var(--bg);
}

.container{
  max-width: 430px;
  margin: 0 auto;
  padding: 16px 14px 44px;
}

.header{
  display:flex;
  justify-content:space-between;
  align-items:flex-start;
  gap:12px;
  margin: 10px 2px 14px;
}
h1{
  font-size: 30px;
  line-height: 1.1;
  margin:0;
  letter-spacing:.2px;
}
.subtitle{
  margin:6px 0 0;
  color:var(--muted);
  font-size:14px;
}

.status{
  display:flex;
  flex-direction:column;
  align-items:flex-end;
  gap:8px;
  margin-top:3px;
}
.pill-status{
  display:inline-flex;
  align-items:center;
  gap:8px;
  padding:8px 10px;
  border-radius:999px;
  border:1px solid rgba(47,124,246,.28);
  background: rgba(47,124,246,.10);
  color: var(--text);
  font-size:13px;
  box-shadow: 0 6px 18px rgba(0,0,0,.20);
}
.dot{
  width:9px; height:9px; border-radius:999px;
  background: var(--blue);
  box-shadow: 0 0 0 3px rgba(47,124,246,.20);
}
.version{
  color: var(--muted2);
  font-size:12px;
}

.card{
  background: linear-gradient(180deg, var(--card2), var(--card));
  border: 1px solid var(--stroke);
  border-radius: 18px;
  padding: 16px;
  box-shadow: var(--shadow);
  margin-bottom: 16px;
}

.card-title{
  display:flex;
  align-items:center;
  justify-content:space-between;
  gap:10px;
  margin: 0 0 12px;
}
.card-title h2{
  margin:0;
  font-size:18px;
  letter-spacing:.2px;
  position:relative;
  padding-bottom:8px;
}
.card-title h2::after{
  content:"";
  position:absolute;
  left:0; bottom:0;
  width:38px; height:2px;
  background: rgba(47,124,246,.85);
  border-radius: 2px;
}

.card.today{
  border-left: 3px solid var(--blue);
}
.badge-date{
  font-size:12px;
  color: rgba(230,234,240,.92);
  padding:6px 10px;
  border-radius:999px;
  border:1px solid rgba(47,124,246,.30);
  background: rgba(47,124,246,.10);
  font-variant-numeric: tabular-nums;
}

.mono{ font-family: ui-monospace, SFMono-Regular, Menlo, monospace; }

/* Import content wrapper: collapses after import */
.import-body{
  transition: max-height .38s ease, opacity .25s ease, margin-top .25s ease;
  max-height: 560px;
  opacity: 1;
  overflow: hidden;
  margin-top: 0;
}
#importCard.is-collapsed .import-body{
  max-height: 0px;
  opacity: 0;
  margin-top: 0;
}

/* Collapsed footer row (Imported + Edit) */
.import-collapsed-row{
  display:none;
  margin-top: 10px;
  padding: 12px;
  border-radius: 14px;
  border: 1px solid var(--stroke);
  background: rgba(255,255,255,.04);
  align-items:center;
  justify-content:space-between;
  gap:12px;
}
#importCard.is-collapsed .import-collapsed-row{
  display:flex;
}
.import-confirm{
  display:flex;
  align-items:center;
  gap:10px;
  font-weight: 750;
  letter-spacing:.2px;
}
.confirm-dot{
  width:10px; height:10px;
  border-radius:999px;
  background: var(--green);
  box-shadow: 0 0 0 3px rgba(76,175,80,.14);
}
.confirm-text{
  color: var(--text);
}
.confirm-sub{
  color: var(--muted);
  font-weight: 600;
  font-size: 12px;
  margin-top: 2px;
}

/* Textarea */
textarea{
  width:100%;
  min-height: 170px;
  resize: vertical;
  border-radius: 14px;
  padding: 12px;
  color: var(--text);
  background: var(--panel);
  border: 1px solid var(--stroke2);
  outline: none;
  font-size: 14px;
  line-height: 1.35;
  box-shadow: inset 0 0 0 1px rgba(0,0,0,.15);
}
textarea:focus{
  border-color: rgba(47,124,246,.55);
  box-shadow:
    0 0 0 4px rgba(47,124,246,.16),
    inset 0 0 0 1px rgba(0,0,0,.10);
}

/* Buttons */
.actions{
  display:flex;
  align-items:center;
  gap:10px;
  margin-top: 12px;
  flex-wrap: wrap;
}
button{
  border: none;
  border-radius: 14px;
  padding: 11px 14px;
  font-size: 15px;
  font-weight: 650;
  cursor: pointer;
  transition: transform .06s ease, filter .12s ease, background .12s ease;
}
button:active{ transform: translateY(1px); }

button.primary{
  background: var(--blue);
  color: white;
  box-shadow: 0 10px 22px rgba(47,124,246,.22);
}
button.primary:hover{ filter: brightness(1.03); }

button.secondary{
  background: rgba(255,255,255,.06);
  color: var(--text);
  border: 1px solid var(--stroke);
}
button.secondary:hover{ filter: brightness(1.05); }

button.ghost{
  background: rgba(47,124,246,.10);
  color: var(--text);
  border: 1px solid rgba(47,124,246,.32);
}
button.ghost:hover{ filter: brightness(1.06); }

/* Tip */
.tip{
  margin-top: 10px;
  font-size: 13px;
  color: var(--muted);
}
.tip b{ color: var(--text); }
.tip code{
  font-family: ui-monospace, SFMono-Regular, Menlo, monospace;
  padding: 1px 6px;
  border-radius: 8px;
  border: 1px solid var(--stroke);
  background: rgba(255,255,255,.04);
}

/* Today metrics */
.grid{
  display:grid;
  grid-template-columns: repeat(3, 1fr);
  gap: 10px;
}
.metric{
  background: rgba(255,255,255,.04);
  border: 1px solid var(--stroke);
  border-radius: 14px;
  padding: 12px;
  text-align:center;
  position:relative;
  overflow:hidden;
}
.metric::before{
  content:"";
  position:absolute;
  inset:-40% -30% auto auto;
  width:130px; height:130px;
  background: radial-gradient(circle at 30% 30%, rgba(47,124,246,.18), transparent 60%);
  transform: rotate(12deg);
  pointer-events:none;
}
.value{
  font-size: 22px;
  font-weight: 780;
  letter-spacing:.2px;
}
.label{
  margin-top: 4px;
  color: var(--muted);
  font-size: 13px;
}

/* Pills */
.pill{
  display:flex;
  align-items:center;
  justify-content:space-between;
  gap:10px;
  background: rgba(255,255,255,.04);
  border: 1px solid var(--stroke);
  border-radius: 14px;
  padding: 10px 12px;
  margin-top: 10px;
  font-size: 14px;
}
.pill .left{
  display:flex;
  align-items:center;
  gap:10px;
  min-width:0;
}
.icon{
  width:26px; height:26px;
  border-radius: 9px;
  display:grid;
  place-items:center;
  color: white;
  background: rgba(47,124,246,.16);
  border: 1px solid rgba(47,124,246,.30);
}
.pill .text{
  color: var(--text);
  white-space: nowrap;
  overflow:hidden;
  text-overflow: ellipsis;
}

/* Snapshot line under Today header */
.snapshot-line{
  margin: -4px 0 10px;
  color: var(--muted);
  font-size: 12px;
}
.snapshot-line b{
  color: var(--text);
  font-weight: 700;
}

/* Trends */
.trend-row{
  display:flex;
  justify-content:space-between;
  align-items:center;
  gap:12px;
  background: rgba(255,255,255,.04);
  border: 1px solid var(--stroke);
  border-radius: 14px;
  padding: 12px;
  margin-top: 10px;
}
.trend-title{ font-weight: 700; }
.trend-meta{
  margin-top: 4px;
  color: var(--muted);
  font-size: 13px;
}

.holding{
  color: var(--muted);
  font-weight: 750;
  letter-spacing:.2px;
}

.arrow{
  font-size: 18px;
  font-weight: 900;
  line-height: 1;
  color: var(--muted);
}
.arrow.green{ color: var(--green); }

/* Goals */
.goal{
  background: rgba(255,255,255,.04);
  border: 1px solid var(--stroke);
  border-radius: 14px;
  padding: 12px;
  margin-top: 8px;
}
</style>
</head>

<body>
  <div class="container">
    <div class="header">
      <div>
        <h1>Performance Logbook</h1>
        <div class="subtitle">Paste nightly snapshot, import, review today &amp; trends.</div>
      </div>

      <div class="status">
        <div class="pill-status"><span class="dot"></span> Live</div>
        <div class="version">A2 ¬∑ v0.6</div>
      </div>
    </div>

    <!-- IMPORT -->
    <div class="card" id="importCard">
      <div class="card-title">
        <h2>Import</h2>
        <div class="subtitle mono">(@day / @run / @lift)</div>
      </div>

      <div class="import-body" id="importBody">
        <textarea id="input" class="mono" spellcheck="false">@day 2026-02-21
weight: 182.0
calories: 2100
protein: 155

@run
type: easy
distance_mi: 3.5
duration: 38:00
avg_pace: 10:51
avg_hr: 153

@lift
bench_press: 200x5, 185x8
seated_row: 160x8
leg_press: 360x10
ez_bar_curl: 85x10</textarea>

        <div class="actions">
          <button class="primary" onclick="importData()">Import</button>
          <button class="secondary" onclick="loadSample()">Load sample</button>
        </div>

        <div class="tip">Tip: use <code>na</code> for missing values. Bench milestones require <b>5+ reps</b> to count.</div>
      </div>

      <div class="import-collapsed-row" id="importCollapsedRow">
        <div>
          <div class="import-confirm">
            <span class="confirm-dot"></span>
            <span class="confirm-text">Imported</span>
          </div>
          <div class="confirm-sub mono" id="importedStamp">‚Äî</div>
        </div>
        <button class="ghost" onclick="editImport()">Edit</button>
      </div>
    </div>

    <!-- TODAY -->
    <div class="card today" id="todayCard">
      <div class="card-title">
        <h2>Today</h2>
        <!-- ACTUAL device date lives here -->
        <span class="badge-date" id="actualTodayDate">‚Äî</span>
      </div>

      <!-- Snapshot date (from last imported entry) -->
      <div class="snapshot-line">Snapshot: <b id="snapshotDate">‚Äî</b></div>

      <div class="grid">
        <div class="metric">
          <div class="value" id="mWeight">‚Äî</div>
          <div class="label">Weight (lbs)</div>
        </div>
        <div class="metric">
          <div class="value" id="mCalories">‚Äî</div>
          <div class="label">Calories</div>
        </div>
        <div class="metric">
          <div class="value" id="mProtein">‚Äî</div>
          <div class="label">Protein (g)</div>
        </div>
      </div>

      <div class="pill">
        <div class="left">
          <div class="icon">üèÉ</div>
          <div class="text" id="runLine">‚Äî</div>
        </div>
      </div>

      <div class="pill">
        <div class="left">
          <div class="icon">üèãÔ∏è</div>
          <div class="text" id="liftLine">‚Äî</div>
        </div>
      </div>
    </div>

    <!-- TRENDS -->
    <div class="card">
      <div class="card-title">
        <h2>Trends</h2>
        <div class="subtitle">Event-based for runs/lifts (gaps don‚Äôt punish you)</div>
      </div>

      <div class="trend-row">
        <div>
          <div class="trend-title">Weight</div>
          <div class="trend-meta" id="tWeightMeta">‚Äî</div>
        </div>
        <div id="tWeightState" class="holding">Holding</div>
      </div>

      <div class="trend-row">
        <div>
          <div class="trend-title">Run (pace @ avg HR ‚â§ 160)</div>
          <div class="trend-meta" id="tRunMeta">‚Äî</div>
        </div>
        <div id="tRunState" class="holding">Holding</div>
      </div>

      <div class="trend-row">
        <div>
          <div class="trend-title">Bench</div>
          <div class="trend-meta" id="tBenchMeta">‚Äî</div>
        </div>
        <div id="tBenchState" class="holding">Holding</div>
      </div>
    </div>

    <!-- RUN GOALS -->
    <div class="card">
      <div class="card-title">
        <h2>Run Goals</h2>
        <div class="subtitle">Avg pace ‚â§ goal AND avg HR ‚â§ 160</div>
      </div>
      <div class="goal" id="goal930">Goal 1: 9:30 /mi ¬∑ ‚Äî</div>
      <div class="goal" id="goal900">Goal 2: 9:00 /mi ¬∑ ‚Äî</div>
    </div>

    <!-- BENCH GOALS -->
    <div class="card">
      <div class="card-title">
        <h2>Bench Goals</h2>
        <div class="subtitle">1RM + milestones</div>
      </div>
      <div class="goal" id="bench1rm">Estimated 1RM: ‚Äî</div>
      <div class="goal" id="bench200">200 √ó 5+: ‚Äî</div>
      <div class="goal" id="bench225">225 √ó 5+: ‚Äî</div>
    </div>
  </div>

<script>
/* ========== Utilities ========== */
function clean(v){
  if (v == null) return null;
  const s = String(v).trim();
  if (!s) return null;
  if (s.toLowerCase() === "na") return null;
  return s;
}
function num(v){
  const s = clean(v);
  if (s == null) return null;
  const n = Number(s);
  return Number.isFinite(n) ? n : null;
}
function parseISODate(iso){
  const m = String(iso || "").match(/^(\d{4})-(\d{2})-(\d{2})$/);
  if (!m) return null;
  return new Date(Date.UTC(Number(m[1]), Number(m[2]) - 1, Number(m[3])));
}
function daysBetweenUTC(a, b){
  const ms = b.getTime() - a.getTime();
  return Math.round(ms / (1000*60*60*24));
}
function epley(w, r){ return Math.round(w * (1 + r / 30)); }

function paceToSeconds(paceStr){
  const s = clean(paceStr);
  if (!s) return null;
  const m = s.match(/^(\d+):([0-5]\d)$/);
  if (!m) return null;
  return Number(m[1]) * 60 + Number(m[2]);
}

/* Actual device date (local) as YYYY-MM-DD */
function deviceISODateLocal(){
  const d = new Date();
  const yyyy = d.getFullYear();
  const mm = String(d.getMonth() + 1).padStart(2, "0");
  const dd = String(d.getDate()).padStart(2, "0");
  return `${yyyy}-${mm}-${dd}`;
}

/* ========== Storage ========== */
const STORAGE_KEY = "plog_days_v1";

function loadDays(){
  try{
    const raw = localStorage.getItem(STORAGE_KEY);
    const arr = raw ? JSON.parse(raw) : [];
    return Array.isArray(arr) ? arr : [];
  }catch{
    return [];
  }
}
function saveDays(arr){
  localStorage.setItem(STORAGE_KEY, JSON.stringify(arr));
}
function upsertDay(entry){
  const days = loadDays();
  const idx = days.findIndex(d => d.date === entry.date);
  if (idx >= 0) days[idx] = entry;
  else days.push(entry);
  days.sort((a,b) => (a.date > b.date ? 1 : a.date < b.date ? -1 : 0));
  saveDays(days);
  return days;
}
function latestDateFromDays(days){
  if (!days.length) return null;
  return days[days.length - 1].date || null;
}

/* ========== Parsing Snapshot ========== */
function parseSnapshot(text){
  const lines = text.split("\n").map(l => l.trim());
  let section = null;

  const day = {};
  const run = {};
  const lift = {};

  const dm = text.match(/@day\s+(\d{4}-\d{2}-\d{2})/);
  const date = dm ? dm[1] : null;

  for (const line of lines){
    if (!line) continue;
    if (line.startsWith("@")){
      section = line.slice(1).trim().split(/\s+/)[0].toLowerCase();
      continue;
    }
    const idx = line.indexOf(":");
    if (idx === -1) continue;

    const k = line.slice(0, idx).trim();
    const v = clean(line.slice(idx + 1).trim());
    if (!k || v == null) continue;

    if (section === "day") day[k] = v;
    if (section === "run") run[k] = v;
    if (section === "lift") lift[k] = v;
  }

  return { date: date || "‚Äî", day, run, lift };
}

/* ========== Import collapse controls ========== */
function nowStamp(){
  const d = new Date();
  const pad = (n) => String(n).padStart(2,"0");
  const yyyy = d.getFullYear();
  const mm = pad(d.getMonth()+1);
  const dd = pad(d.getDate());
  let hh = d.getHours();
  const ampm = hh >= 12 ? "PM" : "AM";
  hh = hh % 12; if (hh === 0) hh = 12;
  const min = pad(d.getMinutes());
  return `${yyyy}-${mm}-${dd} ¬∑ ${hh}:${min} ${ampm}`;
}
function collapseImport(){
  document.getElementById("importCard").classList.add("is-collapsed");
  document.getElementById("importedStamp").textContent = nowStamp();
}
function editImport(){
  document.getElementById("importCard").classList.remove("is-collapsed");
  setTimeout(() => document.getElementById("input").focus(), 150);
}

/* ========== Rendering: Today ========== */
function renderTodayFromLatest(dayEntry){
  // Actual device date (always accurate)
  document.getElementById("actualTodayDate").textContent = deviceISODateLocal();

  // Snapshot date (from last imported entry)
  document.getElementById("snapshotDate").textContent = dayEntry.date || "‚Äî";

  document.getElementById("mWeight").textContent = (dayEntry.weight != null) ? dayEntry.weight.toFixed(1) : "‚Äî";
  document.getElementById("mCalories").textContent = (dayEntry.calories != null) ? String(Math.round(dayEntry.calories)) : "‚Äî";
  document.getElementById("mProtein").textContent = (dayEntry.protein != null) ? String(Math.round(dayEntry.protein)) : "‚Äî";

  const r = dayEntry.run || {};
  if (r.avg_pace || r.avg_hr || r.distance_mi || r.type){
    const parts = [];
    if (r.type) parts.push(r.type);
    if (r.distance_mi != null) parts.push(`${r.distance_mi} mi`);
    if (r.avg_pace) parts.push(`pace ${r.avg_pace}`);
    if (r.avg_hr != null) parts.push(`HR ${r.avg_hr}`);
    document.getElementById("runLine").textContent = parts.join(" ¬∑ ");
  } else {
    document.getElementById("runLine").textContent = "‚Äî";
  }

  const liftKeys = [];
  if (dayEntry.lift && typeof dayEntry.lift === "object"){
    for (const k of Object.keys(dayEntry.lift)){
      if (clean(dayEntry.lift[k]) != null) liftKeys.push(k);
    }
  }
  document.getElementById("liftLine").textContent = liftKeys.length ? liftKeys.join(", ") : "‚Äî";
}

/* ========== Signals ========== */
function setTrendState(elId, state){
  const el = document.getElementById(elId);
  el.className = "";
  if (!state || state.kind === "holding"){
    el.className = "holding";
    el.textContent = "Holding";
    return;
  }
  el.className = "arrow" + (state.improving ? " green" : "");
  el.textContent = state.arrow;
}

/* ========== Trends ========== */
function renderTrends(days){
  const latestISO = latestDateFromDays(days);
  const latestD = parseISODate(latestISO);

  // Weight (last 7 observations)
  const weightObs = days.filter(d => d.weight != null && Number.isFinite(d.weight)).slice(-7);
  const weights = weightObs.map(d => d.weight);
  const wLast = weights.length ? weights[weights.length - 1] : null;
  const wAvg = weights.length ? (weights.reduce((a,b)=>a+b,0) / weights.length) : null;

  if (wLast == null || wAvg == null){
    document.getElementById("tWeightMeta").textContent = "No data yet.";
    setTrendState("tWeightState", {kind:"holding"});
  } else {
    const tol = 0.2;
    let state = {kind:"holding"};
    if (wLast < wAvg - tol) state = {kind:"arrow", arrow:"‚Üì", improving:true};
    else if (wLast > wAvg + tol) state = {kind:"arrow", arrow:"‚Üë", improving:false};
    document.getElementById("tWeightMeta").textContent =
      `Last: ${wLast.toFixed(1)} lbs ¬∑ 7-entry avg: ${wAvg.toFixed(1)} lbs ¬∑ entries: ${weights.length}`;
    setTrendState("tWeightState", state);
  }

  // Run (event-based, qualifying only)
  const qualifyingRuns = days
    .filter(d => d.run && d.run.avg_pace && d.run.avg_hr != null)
    .map(d => ({
      date: d.date,
      dateObj: parseISODate(d.date),
      avg_hr: d.run.avg_hr,
      paceStr: d.run.avg_pace,
      paceSec: paceToSeconds(d.run.avg_pace)
    }))
    .filter(r => r.dateObj && r.paceSec != null && Number.isFinite(r.avg_hr) && r.avg_hr <= 160)
    .sort((a,b) => (a.date > b.date ? 1 : a.date < b.date ? -1 : 0));

  if (!qualifyingRuns.length){
    document.getElementById("tRunMeta").textContent = "No qualifying runs yet (avg HR ‚â§ 160).";
    setTrendState("tRunState", {kind:"holding"});
  } else {
    const last = qualifyingRuns[qualifyingRuns.length - 1];
    const prev = qualifyingRuns.length >= 2 ? qualifyingRuns[qualifyingRuns.length - 2] : null;

    let stale = "";
    if (latestD && last.dateObj){
      const gap = daysBetweenUTC(last.dateObj, latestD);
      stale = ` ¬∑ ${gap}d ago`;
    }

    let state = {kind:"holding"};
    if (prev){
      const tolSec = 5;
      if (last.paceSec < prev.paceSec - tolSec) state = {kind:"arrow", arrow:"‚Üì", improving:true};
      else if (last.paceSec > prev.paceSec + tolSec) state = {kind:"arrow", arrow:"‚Üë", improving:false};
    }

    document.getElementById("tRunMeta").textContent =
      prev
        ? `Last: ${last.date}${stale} ¬∑ ${last.paceStr} @ HR ${last.avg_hr} | Prev: ${prev.paceStr} @ HR ${prev.avg_hr}`
        : `Last: ${last.date}${stale} ¬∑ ${last.paceStr} @ HR ${last.avg_hr} | Prev: ‚Äî`;

    setTrendState("tRunState", state);
  }

  // Bench (event-based)
  const benchSessions = days
    .filter(d => d.bench && d.bench.est1rm != null)
    .map(d => ({
      date: d.date,
      dateObj: parseISODate(d.date),
      est1rm: d.bench.est1rm
    }))
    .filter(b => b.dateObj && Number.isFinite(b.est1rm))
    .sort((a,b) => (a.date > b.date ? 1 : a.date < b.date ? -1 : 0));

  if (!benchSessions.length){
    document.getElementById("tBenchMeta").textContent = "No bench data yet.";
    setTrendState("tBenchState", {kind:"holding"});
  } else {
    const last = benchSessions[benchSessions.length - 1];
    const prev = benchSessions.length >= 2 ? benchSessions[benchSessions.length - 2] : null;

    let stale = "";
    if (latestD && last.dateObj){
      const gap = daysBetweenUTC(last.dateObj, latestD);
      stale = ` ¬∑ ${gap}d ago`;
    }

    let state = {kind:"holding"};
    if (prev){
      const tol = 1;
      if (last.est1rm > prev.est1rm + tol) state = {kind:"arrow", arrow:"‚Üë", improving:true};
      else if (last.est1rm < prev.est1rm - tol) state = {kind:"arrow", arrow:"‚Üì", improving:false};
    }

    document.getElementById("tBenchMeta").textContent =
      prev
        ? `Last: ${last.date}${stale} ¬∑ ${last.est1rm} | Prev: ${prev.est1rm}`
        : `Last: ${last.date}${stale} ¬∑ ${last.est1rm} | Prev: ‚Äî`;

    setTrendState("tBenchState", state);
  }
}

/* ========== Goals ========== */
function renderRunGoals(days){
  const runs = days
    .filter(d => d.run && d.run.avg_pace && d.run.avg_hr != null)
    .map(d => ({ date: d.date, hr: d.run.avg_hr, paceSec: paceToSeconds(d.run.avg_pace) }))
    .filter(r => Number.isFinite(r.hr) && r.paceSec != null && r.hr <= 160)
    .sort((a,b) => (a.date > b.date ? 1 : a.date < b.date ? -1 : 0));

  const last = runs.length ? runs[runs.length - 1] : null;

  function goalLine(goalPaceStr){
    if (!last) return "‚Äî";
    const goalSec = paceToSeconds(goalPaceStr);
    if (goalSec == null) return "‚Äî";
    return (last.paceSec <= goalSec) ? "Met ‚úì" : "Not yet";
  }

  document.getElementById("goal930").textContent = `Goal 1: 9:30 /mi ¬∑ ${goalLine("9:30")}`;
  document.getElementById("goal900").textContent = `Goal 2: 9:00 /mi ¬∑ ${goalLine("9:00")}`;
}

function renderBenchGoalsFromLatest(days){
  const benches = days
    .filter(d => d.bench && d.bench.est1rm != null)
    .sort((a,b) => (a.date > b.date ? 1 : a.date < b.date ? -1 : 0));
  const last = benches.length ? benches[benches.length - 1] : null;

  if (!last){
    document.getElementById("bench1rm").textContent = "Estimated 1RM: ‚Äî";
    document.getElementById("bench200").textContent = "200 √ó 5+: ‚Äî";
    document.getElementById("bench225").textContent = "225 √ó 5+: ‚Äî";
    return;
  }

  document.getElementById("bench1rm").textContent = `Estimated 1RM: ${last.bench.est1rm}`;
  document.getElementById("bench200").textContent = `200 √ó 5+: ${last.bench.hit200 ? "true" : "false"}`;
  document.getElementById("bench225").textContent = `225 √ó 5+: ${last.bench.hit225 ? "true" : "false"}`;
}

/* ========== Import Flow ========== */
function importData(){
  const text = document.getElementById("input").value;
  const parsed = parseSnapshot(text);

  const entry = {
    date: parsed.date,
    weight: num(parsed.day.weight),
    calories: num(parsed.day.calories),
    protein: num(parsed.day.protein),
    run: {
      type: clean(parsed.run.type),
      distance_mi: num(parsed.run.distance_mi),
      duration: clean(parsed.run.duration),
      avg_pace: clean(parsed.run.avg_pace),
      avg_hr: num(parsed.run.avg_hr)
    },
    lift: parsed.lift || {},
    bench: null
  };

  if (parsed.lift && parsed.lift.bench_press){
    const sets = String(parsed.lift.bench_press)
      .split(",")
      .map(s => s.trim())
      .map(s => {
        const m = s.match(/^(\d+)\s*x\s*(\d+)$/i);
        if (!m) return null;
        return { w: Number(m[1]), r: Number(m[2]) };
      })
      .filter(Boolean);

    if (sets.length){
      const est1rm = Math.max(...sets.map(s => epley(s.w, s.r)));
      const hit200 = sets.some(s => s.w >= 200 && s.r >= 5);
      const hit225 = sets.some(s => s.w >= 225 && s.r >= 5);
      entry.bench = { est1rm, hit200, hit225 };
    }
  }

  const days = upsertDay(entry);
  const latest = days[days.length - 1];

  renderTodayFromLatest(latest);
  renderTrends(days);
  renderRunGoals(days);
  renderBenchGoalsFromLatest(days);

  collapseImport();

  setTimeout(() => {
    document.getElementById("todayCard").scrollIntoView({behavior:"smooth", block:"start"});
  }, 250);
}

function loadSample(){
  document.getElementById("input").value =
`@day 2026-02-22
weight: 181.0
calories: 2100
protein: 155

@run
type: easy
distance_mi: 3.5
duration: 38:00
avg_pace: 10:51
avg_hr: 153

@lift
bench_press: 200x5, 185x8
seated_row: 160x8
leg_press: 360x10
ez_bar_curl: 85x10`;
}

/* ========== Init ========== */
(function init(){
  // Always show actual device date even with no data
  document.getElementById("actualTodayDate").textContent = deviceISODateLocal();

  const days = loadDays();
  if (!days.length){
    document.getElementById("snapshotDate").textContent = "‚Äî";
    document.getElementById("tWeightMeta").textContent = "No data yet.";
    document.getElementById("tRunMeta").textContent = "No qualifying runs yet (avg HR ‚â§ 160).";
    document.getElementById("tBenchMeta").textContent = "No bench data yet.";
    return;
  }
  const latest = days[days.length - 1];
  renderTodayFromLatest(latest);
  renderTrends(days);
  renderRunGoals(days);
  renderBenchGoalsFromLatest(days);
})();
</script>
</body>
</html>
