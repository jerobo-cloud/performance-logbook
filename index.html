<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>Performance Logbook</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<style>
  :root {
    --bg: #0b0f14;
    --card: #151a21;
    --muted: #9aa4b2;
    --text: #e6edf3;
    --accent: #3b82f6;
    --success: #22c55e;
    --danger: #ef4444;
    --radius: 14px;

    --chip: #1d2430;
    --border: #253042;
    --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace;
  }

  * { box-sizing: border-box; }
  body {
    margin: 0;
    font-family: -apple-system, BlinkMacSystemFont, system-ui, sans-serif;
    background: var(--bg);
    color: var(--text);
    padding: 16px;
  }
  h1 { font-size: 26px; margin: 0 0 6px; }
  .sub { color: var(--muted); font-size: 13px; margin-bottom: 14px; }

  .card {
    background: linear-gradient(180deg, #1a2029, var(--card));
    border-radius: var(--radius);
    padding: 14px;
    margin-bottom: 14px;
  }
  h2 { font-size: 18px; margin: 0 0 10px; }

  textarea {
    width: 100%;
    min-height: 140px;
    background: #0f1520;
    color: var(--text);
    border: 1px solid var(--border);
    border-radius: 10px;
    padding: 10px;
    font-family: var(--mono);
    font-size: 14px;
    line-height: 1.35;
  }

  button {
    background: var(--accent);
    color: white;
    border: none;
    border-radius: 10px;
    padding: 10px 14px;
    font-weight: 650;
    margin-right: 8px;
  }
  button.secondary { background: var(--border); }

  .muted { color: var(--muted); font-size: 13px; }
  .success { color: var(--success); font-weight: 650; }
  .danger { color: var(--danger); font-weight: 650; }

  .row {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 10px;
  }
  .stat {
    background: var(--chip);
    border-radius: 12px;
    padding: 12px;
    text-align: center;
  }
  .stat .value { font-size: 22px; font-weight: 750; }
  .stat .label { font-size: 12px; color: var(--muted); }

  .chip {
    background: var(--chip);
    border-radius: 999px;
    padding: 10px 12px;
    margin-top: 10px;
    font-size: 14px;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
  }

  .collapsed { display: none; }

  code {
    background:#0f1520;
    border:1px solid var(--border);
    padding: 1px 6px;
    border-radius: 999px;
    font-family: var(--mono);
    font-size: 12px;
    color: var(--text);
  }

  .trendBlock { display: grid; grid-template-columns: 1fr; gap: 10px; }
  .trendItem { background: var(--chip); border-radius: 12px; padding: 12px; }
  .trendHeader { display:flex; align-items: baseline; justify-content: space-between; gap: 10px; }
  .tTitle { font-weight: 800; }
  .tSignal { font-weight: 900; letter-spacing: 0.5px; }
  .tLine { color: var(--muted); font-size: 13px; line-height: 1.35; margin-top: 6px; }
</style>
</head>

<body>

<h1>Performance Logbook</h1>
<div class="sub">Paste nightly snapshot, import, review today & trends.</div>

<!-- IMPORT -->
<div class="card" id="importCard">
  <h2>Import</h2>
  <textarea id="input" placeholder="@day 2026-02-21
weight: 182.0
calories: 2100
protein: 155

@run
type: easy
distance_mi: 3.5
duration: 38:00
avg_pace: 10:51
avg_hr: 153

@lift
bench_press: 200x5, 185x8, 175x10"></textarea>
  <div style="margin-top:10px">
    <button onclick="importSnapshot()">Import</button>
    <button class="secondary" onclick="loadSample()">Load sample</button>
    <button class="secondary" onclick="showImport()">Edit</button>
    <span id="importStatus" class="success"></span>
  </div>
  <div class="muted" style="margin-top:6px">
    Tip: use <code>na</code> for missing values. Bench milestones require <b>5+ reps</b>.
  </div>
</div>

<!-- TODAY -->
<div class="card">
  <h2>Today <span class="muted" id="todayDate"></span></h2>

  <div class="row">
    <div class="stat">
      <div class="value" id="w">—</div>
      <div class="label">Weight (lbs)</div>
    </div>
    <div class="stat">
      <div class="value" id="c">—</div>
      <div class="label">Calories</div>
    </div>
    <div class="stat">
      <div class="value" id="p">—</div>
      <div class="label">Protein (g)</div>
    </div>
  </div>

  <div class="chip" id="runChip">Run · —</div>
  <div class="chip" id="liftChip">Lift · —</div>
</div>

<!-- TRENDS -->
<div class="card">
  <h2>Trends</h2>

  <div class="trendBlock">
    <div class="trendItem">
      <div class="trendHeader">
        <div class="tTitle">Weight</div>
        <div class="tSignal" id="sigWeight">—</div>
      </div>
      <div class="tLine" id="trendWeight">—</div>
    </div>

    <div class="trendItem">
      <div class="trendHeader">
        <div class="tTitle">Run (pace @ avg HR ≤ 160)</div>
        <div class="tSignal" id="sigRun">—</div>
      </div>
      <div class="tLine" id="trendRun">—</div>
    </div>

    <div class="trendItem">
      <div class="trendHeader">
        <div class="tTitle">Bench</div>
        <div class="tSignal" id="sigBench">—</div>
      </div>
      <div class="tLine" id="trendBench">—</div>
    </div>
  </div>
</div>

<!-- RUN GOALS -->
<div class="card">
  <h2>Run Goals</h2>
  <div class="muted">Meeting goal = avg pace ≤ goal pace AND avg HR ≤ 160.</div>
  <div class="chip" id="goal930">Goal 1: 9:30 /mi · —</div>
  <div class="chip" id="goal900">Goal 2: 9:00 /mi · —</div>
</div>

<!-- LIFT GOALS -->
<div class="card">
  <h2>Bench Goals</h2>
  <div class="chip" id="benchGoals">—</div>
</div>

<script>
  // ---------- helpers ----------
  function clean(v){
    if (v == null) return null;
    const s = String(v).trim();
    if (!s) return null;
    if (s.toLowerCase() === 'na') return null;
    return s;
  }

  function epley(w, r) { return Math.round(w * (1 + r / 30)); }

  function paceToSeconds(paceStr){
    const s = clean(paceStr);
    if (!s) return null;
    const m = s.match(/^(\d+):([0-5]\d)$/);
    if (!m) return null;
    return Number(m[1]) * 60 + Number(m[2]);
  }

  function avg(nums){
    if (!nums.length) return null;
    return nums.reduce((a,b)=>a+b,0) / nums.length;
  }

  function loadLog(){
    try{
      const raw = localStorage.getItem('plog_days');
      const arr = raw ? JSON.parse(raw) : [];
      return Array.isArray(arr) ? arr : [];
    }catch{
      return [];
    }
  }

  function saveLog(arr){
    localStorage.setItem('plog_days', JSON.stringify(arr));
  }

  function upsertDay(entry){
    const log = loadLog();
    const idx = log.findIndex(d => d.date === entry.date);
    if (idx >= 0) log[idx] = entry;
    else log.push(entry);
    log.sort((a,b)=> (a.date > b.date ? 1 : a.date < b.date ? -1 : 0));
    saveLog(log);
    return log;
  }

  function showImport(){
    document.getElementById('importCard').classList.remove('collapsed');
    document.getElementById('importStatus').textContent = '';
    document.getElementById('importStatus').className = 'success';
  }

  // ---------- parsing ----------
  function parseSnapshot(text){
    const lines = text.split('\n').map(l => l.trim());
    let section = null;

    const day = {};
    const run = {};
    const lift = {};

    // date from "@day YYYY-MM-DD"
    const dm = text.match(/@day\s+(\d{4}-\d{2}-\d{2})/);
    const date = dm ? dm[1] : null;

    for (const line of lines) {
      if (!line) continue;
      if (line.startsWith('@')) {
        section = line.slice(1).trim().split(/\s+/)[0].toLowerCase();
        continue;
      }
      const idx = line.indexOf(':');
      if (idx === -1) continue;
      const k = line.slice(0, idx).trim();
      const v = clean(line.slice(idx+1).trim());
      if (!k || v == null) continue;

      if (section === 'day') day[k] = v;
      if (section === 'run') run[k] = v;
      if (section === 'lift') lift[k] = v;
    }

    return { date: date || (day.date || '—'), day, run, lift };
  }

  // ---------- today rendering ----------
  function renderToday(parsed){
    const date = parsed.date || '—';
    document.getElementById('todayDate').textContent = date;

    document.getElementById('w').textContent = parsed.day.weight ?? '—';
    document.getElementById('c').textContent = parsed.day.calories ?? '—';
    document.getElementById('p').textContent = parsed.day.protein ?? '—';

    // avg_pace is displayed verbatim (string)
    const run = parsed.run || {};
    if (run.type || run.distance_mi || run.avg_pace || run.avg_hr) {
      const t = run.type ?? 'run';
      const dist = run.distance_mi ? `${run.distance_mi} mi` : '— mi';
      const pace = run.avg_pace ? `${run.avg_pace}` : '—';
      const hr = run.avg_hr ? `${run.avg_hr}` : '—';
      document.getElementById('runChip').textContent =
        `Run · ${t} · ${dist} · pace ${pace} · HR ${hr}`;
    } else {
      document.getElementById('runChip').textContent = 'Run · —';
    }

    const lift = parsed.lift || {};
    const liftKeys = Object.keys(lift).filter(k => k !== 'bench_press');
    const hasBench = !!lift.bench_press;

    let liftLabel = [];
    if (hasBench) liftLabel.push('bench_press');
    liftLabel.push(...liftKeys);

    document.getElementById('liftChip').textContent =
      liftLabel.length ? `Lift · ${liftLabel.join(', ')}` : 'Lift · —';

    renderBenchGoals(lift);
    renderRunGoals(run);
  }

  function renderBenchGoals(lift){
    let est = null;
    let hit200 = false;
    let hit225 = false;

    if (lift && lift.bench_press) {
      const sets = lift.bench_press.split(',')
        .map(s => s.trim())
        .map(s => {
          const m = s.match(/^(\d+)\s*x\s*(\d+)$/i);
          if (!m) return null;
          return { w: Number(m[1]), r: Number(m[2]) };
        })
        .filter(Boolean);

      if (sets.length){
        est = Math.max(...sets.map(s => epley(s.w, s.r)));
        hit200 = sets.some(s => s.w >= 200 && s.r >= 5);
        hit225 = sets.some(s => s.w >= 225 && s.r >= 5);
      }
    }

    document.getElementById('benchGoals').textContent =
      (est == null)
        ? 'Estimated 1RM: — · 200×5+: — · 225×5+: —'
        : `Estimated 1RM: ${est} · 200×5+: ${hit200} · 225×5+: ${hit225}`;
  }

  function renderRunGoals(run){
    const paceSec = paceToSeconds(run.avg_pace);
    const hr = run.avg_hr ? Number(run.avg_hr) : null;
    const qualifiesHR = (hr != null && hr <= 160);

    function goalLine(goalPaceStr){
      const g = paceToSeconds(goalPaceStr);
      if (paceSec == null || hr == null) return '—';
      const meets = (qualifiesHR && paceSec <= g);
      return meets ? 'Met ✓' : 'Not yet';
    }

    document.getElementById('goal930').textContent = `Goal 1: 9:30 /mi · ${goalLine('9:30')}`;
    document.getElementById('goal900').textContent = `Goal 2: 9:00 /mi · ${goalLine('9:00')}`;
  }

  // ---------- trend signals ----------
  // Holding = label only. Otherwise arrow only.
  // Weight: down is improving (lower), up is regressing (higher).
  // Run pace: down is improving (pace dropping), up is regressing.
  // Bench: up is improving (strength increasing), down is regressing.
  function setSignal(elId, kind){
    // kind: 'down' | 'up' | 'hold' | 'na'
    const el = document.getElementById(elId);
    if (!el) return;
    if (kind === 'hold') el.textContent = 'Holding';
    else if (kind === 'down') el.textContent = '↓';
    else if (kind === 'up') el.textContent = '↑';
    else el.textContent = '—';
  }

  function renderTrends(log){
    const last7 = log.slice(-7);

    // --- Weight ---
    const weights = last7.map(d => Number(d.weight)).filter(x => isFinite(x));
    const wAvg = avg(weights);
    const wLast = (weights.length ? weights[weights.length-1] : null);

    if (wAvg == null || wLast == null) {
      setSignal('sigWeight', 'na');
      document.getElementById('trendWeight').textContent = 'No data yet.';
    } else {
      const tol = 0.2; // lbs
      let sig = 'hold';
      if (wLast < wAvg - tol) sig = 'down';      // improving
      else if (wLast > wAvg + tol) sig = 'up';   // regressing
      setSignal('sigWeight', sig);
      document.getElementById('trendWeight').textContent =
        `Last: ${wLast.toFixed(1)} lbs · 7-day avg: ${wAvg.toFixed(1)} lbs · entries: ${weights.length}`;
    }

    // --- Run (qualifying HR<=160) ---
    const qRuns = log
      .filter(d => d.run && d.run.avg_hr != null && d.run.avg_pace)
      .map(d => ({
        date: d.date,
        hr: Number(d.run.avg_hr),
        paceStr: d.run.avg_pace,
        paceSec: paceToSeconds(d.run.avg_pace)
      }))
      .filter(x => isFinite(x.hr) && x.hr <= 160 && x.paceSec != null);

    if (!qRuns.length) {
      setSignal('sigRun', 'na');
      document.getElementById('trendRun').textContent = 'No qualifying runs yet (avg HR ≤ 160).';
    } else {
      const lastQ = qRuns[qRuns.length - 1];
      const bestQ = qRuns.reduce((best, cur) => cur.paceSec < best.paceSec ? cur : best, qRuns[0]);

      // compare last qualifying to best-to-date (improvement = down arrow)
      const tolSec = 5; // within 5 seconds = holding
      let sig = 'hold';
      if (lastQ.paceSec < bestQ.paceSec - tolSec) sig = 'down';         // improved beyond best (rare)
      else if (lastQ.paceSec > bestQ.paceSec + tolSec) sig = 'up';      // worse than best
      // NOTE: if last == best (or within tol), holding.
      // This yields a simple "am I at my best?" signal until we add "recent baseline" later.
      setSignal('sigRun', sig);

      document.getElementById('trendRun').textContent =
        `Last qualifying: ${lastQ.date} · pace ${lastQ.paceStr} · HR ${lastQ.hr} | Best: ${bestQ.paceStr} (${bestQ.date})`;
    }

    // --- Bench ---
    const benches = log
      .filter(d => d.bench && d.bench.est1rm != null)
      .map(d => ({ date: d.date, est1rm: Number(d.bench.est1rm) }))
      .filter(x => isFinite(x.est1rm));

    if (!benches.length) {
      setSignal('sigBench', 'na');
      document.getElementById('trendBench').textContent = 'No bench data yet.';
    } else {
      const lastB = benches[benches.length-1];
      const bestB = benches.reduce((best, cur) => cur.est1rm > best.est1rm ? cur : best, benches[0]);

      let sig = 'hold';
      if (lastB.est1rm > bestB.est1rm) sig = 'up'; // improved beyond best (rare due to how best is defined)
      else if (lastB.est1rm < bestB.est1rm) sig = 'down';
      // same as best -> holding
      setSignal('sigBench', sig);

      document.getElementById('trendBench').textContent =
        `Last: ${lastB.est1rm} (on ${lastB.date}) · Best: ${bestB.est1rm} (on ${bestB.date}) · entries: ${benches.length}`;
    }
  }

  // ---------- import flow ----------
  function importSnapshot(){
    try{
      const text = document.getElementById('input').value;
      const parsed = parseSnapshot(text);

      const entry = {
        date: parsed.date,
        weight: parsed.day.weight ? Number(parsed.day.weight) : null,
        calories: parsed.day.calories ? Number(parsed.day.calories) : null,
        protein: parsed.day.protein ? Number(parsed.day.protein) : null,
        run: {
          type: parsed.run.type ?? null,
          distance_mi: parsed.run.distance_mi ? Number(parsed.run.distance_mi) : null,
          duration: parsed.run.duration ?? null,
          avg_pace: parsed.run.avg_pace ?? null, // string
          avg_hr: parsed.run.avg_hr ? Number(parsed.run.avg_hr) : null
        },
        bench: null
      };

      if (parsed.lift && parsed.lift.bench_press){
        const sets = parsed.lift.bench_press.split(',')
          .map(s => s.trim())
          .map(s => {
            const m = s.match(/^(\d+)\s*x\s*(\d+)$/i);
            if (!m) return null;
            return { w: Number(m[1]), r: Number(m[2]) };
          })
          .filter(Boolean);

        if (sets.length){
          const est1rm = Math.max(...sets.map(s => epley(s.w, s.r)));
          const hit200 = sets.some(s => s.w >= 200 && s.r >= 5);
          const hit225 = sets.some(s => s.w >= 225 && s.r >= 5);
          entry.bench = { est1rm, hit200, hit225 };
        }
      }

      const log = upsertDay(entry);
      renderToday(parsed);
      renderTrends(log);

      document.getElementById('importStatus').textContent = 'Imported ✓';
      document.getElementById('importStatus').className = 'success';
      document.getElementById('importCard').classList.add('collapsed');
    }catch(e){
      document.getElementById('importStatus').textContent = 'Import failed';
      document.getElementById('importStatus').className = 'danger';
    }
  }

  function loadSample(){
    document.getElementById('input').value =
`@day 2026-02-21
weight: 182.0
calories: 2100
protein: 155

@run
type: easy
distance_mi: 3.5
duration: 38:00
avg_pace: 10:51
avg_hr: 153

@lift
bench_press: 200x5, 185x8, 175x10`;
  }

  // ---------- init ----------
  (function init(){
    renderTrends(loadLog());
  })();
</script>

</body>
</html>
